//Copyright 2014 The Rector & Visitors of the University of Virginia
//
//Permission is hereby granted, free of charge, to any person obtaining a copy 
//of this software and associated documentation files (the "Software"), to deal 
//in the Software without restriction, including without limitation the rights
//to use, copy, modify, merge, publish, distribute, sublicense, and/or sell 
//copies of the Software, and to permit persons to whom the Software is 
//furnished to do so, subject to the following conditions:
//
//The above copyright notice and this permission notice shall be included in 
//all copies or substantial portions of the Software.
//
//THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED,
//INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A 
//PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT 
//HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION 
//OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE 
//SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.

using System;
using System.Collections.Generic;
using Newtonsoft.Json;
using Sensus.Anonymization;
using Sensus.Anonymization.Anonymizers;
using Sensus.Exceptions;

namespace Sensus
{
    /// <summary>
    /// A single unit of sensed information returned by a probe.
    /// </summary>
    public abstract class Datum : IDatum
    {
        /// <summary>
        /// Settings for serializing Datum objects
        /// </summary>
        private static readonly JsonSerializerSettings JSON_SERIALIZER_SETTINGS = new JsonSerializerSettings
        {
            TypeNameHandling = TypeNameHandling.All,
            ConstructorHandling = ConstructorHandling.AllowNonPublicDefaultConstructor
        };

        public static Datum FromJSON(string json)
        {
            // null datum properties in the json come from a few places:  a reference-type property that is 
            // null (e.g., a string), a nullable property that has no value, and a property to which a 
            // value-omitting anonymizer is applied. the first two cases will not cause issues when 
            // deserializing. the final case will be problematic if the property is a value-type since we 
            // cannot assign null to a value type. so we're going to ignore null values when deserializing
            // data. in the first two cases above, the property will have the appropriate null value. in the 
            // third case the property will have its default value. be aware that value-type datum type properties
            // with value-omitting anonymizers can thus have their values changed when serialized and then 
            // deserialized (from the original value to their default value). this will usually be okay because
            // any subsequent serialization will omit the value again.
            JSON_SERIALIZER_SETTINGS.NullValueHandling = NullValueHandling.Ignore;

            Datum datum = null;

            try
            {
                datum = JsonConvert.DeserializeObject<Datum>(json, JSON_SERIALIZER_SETTINGS);
            }
            catch (Exception ex)
            {
                SensusServiceHelper.Get().Logger.Log("Failed to convert JSON to datum:  " + ex.Message, LoggingLevel.Normal, typeof(Datum));
            }

            return datum;
        }

        private string _id;
        private string _deviceId;
        private DateTimeOffset _timestamp;
        private string _protocolId;
        private int _hashCode;
        private bool _anonymized;
        private string _buildId;
        private string _participantId;
        private string _deviceManufacturer;
        private string _deviceModel;
        private string _operatingSystem;
        private string _taggedEventId;
        private List<string> _taggedEventTags;

        /// <summary>
        /// Unique identifier for the current <see cref="Datum"/>, unique across all data generated by all Sensus apps.
        /// </summary>
        /// <value>The identifier.</value>
        public string Id
        {
            get { return _id; }
            set
            {
                _id = value;
                _hashCode = _id.GetHashCode();
            }
        }

        /// <summary>
        /// An identifier that is unique to the particular device running Sensus. The meaning of this identifier
        /// and conditions under which it can change are described in the following pages:
        /// 
        /// * Android:  See [here](https://developer.android.com/reference/android/provider/Settings.Secure.html#ANDROID_ID).
        /// * iOS:  See [here](https://developer.apple.com/documentation/uikit/uidevice/1620059-identifierforvendor).
        /// 
        /// </summary>
        /// <value>The device identifier.</value>
        [Anonymizable("Device ID:", typeof(StringHashAnonymizer), false)]
        public string DeviceId
        {
            get { return _deviceId; }
            set { _deviceId = value; }
        }

        /// <summary>
        /// Date and time at which a data element from the Probe was read.
        /// </summary>
        /// <value>The timestamp.</value>
        [Anonymizable(null, typeof(DateTimeOffsetTimelineAnonymizer), false)]
        public DateTimeOffset Timestamp
        {
            get { return _timestamp; }
            set { _timestamp = value; }
        }

        /// <summary>
        /// A unique identifier for the <see cref="Protocol"/> that generated this <see cref="Datum"/>.
        /// </summary>
        /// <value>The protocol identifier.</value>
        public string ProtocolId
        {
            get
            {
                return _protocolId;
            }
            set
            {
                _protocolId = value;
            }
        }

        /// <summary>
        /// Whether or not this <see cref="Datum"/> has been run through an anonymizer.
        /// </summary>
        /// <value><c>true</c> if anonymized; otherwise, <c>false</c>.</value>
        [JsonIgnore]
        public bool Anonymized
        {
            get
            {
                return _anonymized;
            }
            set
            {
                _anonymized = value;
            }
        }

        /// <summary>
        /// The identifier for the build of Sensus that generated this datum.
        /// </summary>
        /// <value>The build identifier.</value>
        public string BuildId
        {
            get { return _buildId; }
            set { _buildId = value; }
        }

        /// <summary>
        /// The identifier for the participant that generated this datum. This will be null if 
        /// <see cref="Protocol.StartConfirmationMode"/> is set to <see cref="ProtocolStartConfirmationMode.None"/> or
        /// <see cref="ProtocolStartConfirmationMode.RandomDigits"/>. If <see cref="Protocol.StartConfirmationMode"/> is 
        /// set to <see cref="ProtocolStartConfirmationMode.ParticipantIdDigits"/> or <see cref="ProtocolStartConfirmationMode.ParticipantIdText"/>
        /// then this will be the value entered by the user. If <see cref="Protocol.StartConfirmationMode"/> is set to 
        /// <see cref="ProtocolStartConfirmationMode.ParticipantIdQrCode"/> then this will be the value of the scanned QR code.
        /// </summary>
        /// <value>The participant identifier.</value>
        public string ParticipantId
        {
            get { return _participantId; }
            set { _participantId = value; }
        }

        /// <summary>
        /// The device manufacturer.
        /// </summary>
        /// <value>The device manufacturer.</value>
        public string DeviceManufacturer
        {
            get { return _deviceManufacturer; }
            set { _deviceManufacturer = value; }
        }

        /// <summary>
        /// The device model.
        /// </summary>
        /// <value>The device model.</value>
        public string DeviceModel
        {
            get { return _deviceModel; }
            set { _deviceModel = value; }
        }

        /// <summary>
        /// The operating system.
        /// </summary>
        /// <value>The operating system.</value>
        public string OperatingSystem
        {
            get { return _operatingSystem; }
            set { _operatingSystem = value; }
        }

        /// <summary>
        /// The event identifier, as described [here](xref:tagging_mode).
        /// </summary>
        /// <value>The tagged event identifier.</value>
        public string TaggedEventId
        {
            get { return _taggedEventId; }
            set { _taggedEventId = value; }
        }

        /// <summary>
        /// The event tags, as described [here](xref:tagging_mode).
        /// </summary>
        /// <value>The tagged event identifier.</value>
        public List<string> TaggedEventTags
        {
            get { return _taggedEventTags; }
            set { _taggedEventTags = value; }
        }

        [JsonIgnore]
        public abstract string DisplayDetail { get; }

        /// <summary>
        /// Gets the string placeholder value, which is used as a formatting replacement in strings 
        /// such as <see cref="Probes.User.Scripts.Script.Caption"/> and <see cref="UI.Inputs.Input.LabelText"/>.
        /// </summary>
        /// <value>The string placeholder value.</value>
        [JsonIgnore]
        public abstract object StringPlaceholderValue { get; }

        /// <summary>
        /// Parameterless constructor For JSON.NET deserialization.
        /// </summary>
        protected Datum()
        {
        }

        protected Datum(DateTimeOffset timestamp)
        {
            // datum objects are often constructed while on the UI thread, so anything bad here has the 
            // potential to crash the app. catch any exceptions, which should not be possible what
            // we're actually doing...but nonetheless.
            try
            {
                _timestamp = timestamp;
                _deviceId = SensusServiceHelper.Get().DeviceId;
                _anonymized = false;
                _buildId = SensusServiceHelper.BUILD_ID;
                _deviceManufacturer = SensusServiceHelper.Get().DeviceManufacturer;
                _deviceModel = SensusServiceHelper.Get().DeviceModel;
                _operatingSystem = SensusServiceHelper.Get().OperatingSystem;

                Id = Guid.NewGuid().ToString();
            }
            catch (Exception ex)
            {
                SensusException.Report("Exception while constructing datum:  " + ex.Message, ex);
            }
        }

        public string GetJSON(AnonymizedJsonContractResolver anonymizationContractResolver, bool indented)
        {
            JSON_SERIALIZER_SETTINGS.ContractResolver = anonymizationContractResolver;

            // datum objects can be anonymized by omitting values. this is accomplished by setting them to null. also, some fields in datum 
            // objects might have unreliably obtained values (e.g., GPS location might fail and be null). if we ignore fields with null
            // values when serializing, the resulting JSON and other derived structures (e.g., data frames in R) will have differing columns. 
            // so we should include null values to ensure that all JSON values are always included.
            JSON_SERIALIZER_SETTINGS.NullValueHandling = NullValueHandling.Include;

            string json = JsonConvert.SerializeObject(this, indented ? Formatting.Indented : Formatting.None, JSON_SERIALIZER_SETTINGS);

            // if the json should not be indented, replace all newlines with white space
            if (!indented)
            {
                json = json.Replace('\n', ' ').Replace('\r', ' ');
            }

            return json.Trim();
        }

        public override int GetHashCode()
        {
            return _hashCode;
        }

        public override bool Equals(object obj)
        {
            return obj is Datum && (obj as Datum)._id == _id;
        }

        public override string ToString()
        {
            return "Type:  " + GetType().Name + Environment.NewLine +
                   "Device ID:  " + _deviceId + Environment.NewLine +
                   "Timestamp:  " + _timestamp;
        }
    }
}
